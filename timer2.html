<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>프로 마작 타이머 v2.5</title>
    <style>
        
        :root {
            --bg-color: #FDFCF0;     /* 전체 배경 */
            --line-color: #333333;   /* 경계선 색상 */
            --blue-color: #34A8DB;   /* 현재 차례 플레이어 강조색 */
            --pink-color: #F7A8A8;   /* 울기 버튼 색상 */
            --red-color: #E74C3C;    /* 경고 및 페널티 색상 */
            --dark-color: #2C3E50;   /* 종료 버튼 색상 */
            --oya-color: #F1C40F;    /* 오야(친) 활성화 색상 (노란색) */
            --green-color: #2ECC71;  /* 시작 버튼 색상 */
        }

        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            overflow: hidden;
            background-color: var(--bg-color);
            font-family: "Noto Sans KR", sans-serif;
            user-select: none; 
        }

        /* 2x2 격자 레이아웃 (4인 영역) */
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            width: 100vw; height: 100vh;
        }

        /* 각 플레이어의 개인 박스 */
        .player-box {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 0.5px solid var(--line-color);
            transition: all 0.3s ease;
            padding: 10px;
        }

        /* 상단 플레이어(동, 북)는 거꾸로 보이게 180도 회전 */
        .p-top { transform: rotate(180deg); }

        /* 내부 콘텐츠 배치 */
        .content { display: flex; flex-direction: column; align-items: center; z-index: 5; width: 100%; }

        /* 방위(동남서북) */
        .kanji { font-size: clamp(1.2rem, 5vw, 2.2rem); font-weight: bold; opacity: 0.4; margin-bottom: -2px; }
        
        /* 메인 숫자 타이머 */
        .timer { 
            font-size: clamp(2.5rem, 12vw, 5rem); 
            font-family: 'Courier New', monospace; 
            font-weight: bold; 
            margin: 2px 0; 
            line-height: 1;
        }
        
        /* 5초 미만일 때 깜빡이는 효과 */
        .urgent { color: var(--red-color); animation: blink 0.5s infinite alternate; transform: scale(1.05); }
        @keyframes blink { from { opacity: 1; } to { opacity: 0.4; } }

        /* 페널티 카운터 */
        .penalty-container {
            background-color: rgba(0,0,0,0.05);
            padding: 2px 8px;
            border-radius: 15px;
            font-weight: bold; 
            font-size: clamp(0.7rem, 2vw, 0.9rem); 
            color: #555;
        }
        .penalty-count { color: var(--red-color); font-size: 1.1em; }

        /* 오야(친) 표시기 위치 설정 */
        .oya-mark {
            position: absolute;
            width: clamp(35px, 10vw, 50px); height: clamp(35px, 10vw, 50px);
            background-color: #ddd; /* 평소엔 회색 */
            border-radius: 20%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: clamp(0.9rem, 3vw, 1.3rem); color: white;
            transition: all 0.3s; cursor: pointer;
            z-index: 30;
        }
        .is-oya .oya-mark { background-color: var(--oya-color); box-shadow: 0 0 10px rgba(241, 196, 15, 0.5); color: #333; }

        /* 오야 표시 위치 */
        .box-0 .oya-mark { bottom: 15px; right: 15px; } /* 동: 우하단 */
        .box-1 .oya-mark { top: 15px; left: 15px; }    /* 남: 좌상단 */
        .box-2 .oya-mark { top: 15px; right: 15px; }   /* 서: 우상단 */
        .box-3 .oya-mark { bottom: 15px; left: 15px; }  /* 북: 좌하단 */

        /* 활성화된 배경색 */
        .active-bg { background-color: rgba(52, 168, 219, 0.12) !important; }
        .active-text { color: var(--blue-color); }

        /* 울기 버튼 */
        .cry-btn {
            position: absolute;
            width: clamp(65px, 18vw, 100px); height: clamp(65px, 18vw, 100px);
            background-color: var(--pink-color);
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: clamp(0.8rem, 3vw, 1.1rem); color: white;
            z-index: 20; cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        /* 각 모서리에 부채꼴 모양으로 배치 */
        .box-0 .cry-btn, .box-2 .cry-btn { top: 0; left: 0; border-radius: 0 0 100% 0; }
        .box-3 .cry-btn, .box-1 .cry-btn { top: 0; right: 0; border-radius: 0 0 0 100%; }

        /*  하단 버튼 */
        .controls {
            position: absolute;
            bottom: 20px; left: 50%;
            transform: translateX(-50%);
            display: flex; gap: 10px;
            z-index: 110;
            width: 95%;
            justify-content: center;
        }

        .btn {
            flex: 1;
            max-width: 150px;
            padding: 12px 5px;
            border-radius: 12px;
            font-weight: bold; 
            font-size: clamp(0.75rem, 2.5vw, 0.95rem);
            color: white; border: none; cursor: pointer;
        }
        .start-pause-btn { background-color: var(--green-color); }
        .start-pause-btn.running { background-color: var(--red-color); }
        .next-btn { background-color: var(--blue-color); }
        .finish-btn { background-color: var(--dark-color); }

        /* 상단 시간 설정 */
        #time-setter {
            position: absolute;
            top: 15px; left: 50%;
            transform: translateX(-50%);
            z-index: 110;
            padding: 5px 12px; border-radius: 10px;
            border: 2px solid var(--line-color);
            background: white; font-weight: bold;
        }
    </style>
</head>
<body>

<select id="time-setter" onchange="resetTimeSetting()">
    <option value="15">제한시간: 15초</option>
    <option value="20">제한시간: 20초</option>
    <option value="25" selected>제한시간: 25초</option>
    <option value="30">제한시간: 30초</option>
    <option value="35">제한시간: 35초</option>
    <option value="40">제한시간: 40초</option>
    <option value="45">제한시간: 45초</option>
    <option value="50">제한시간: 50초</option>
    <option value="55">제한시간: 55초</option>
    <option value="60">제한시간: 60초</option>
</select>

<div class="container">
    <div id="box-0" class="player-box box-0 p-top" onclick="handleAreaTap(0)">
        <div class="cry-btn" onclick="handleCry(event, 0)">울기</div>
        <div class="oya-mark" onclick="setOya(event, 0)">친</div>
        <div class="content">
            <div class="kanji">동</div>
            <div id="timer-0" class="timer">00:25</div>
            <div class="penalty-container">페널티 <span id="penalty-0" class="penalty-count">0</span></div>
        </div>
    </div>
    <div id="box-3" class="player-box box-3 p-top" onclick="handleAreaTap(3)">
        <div class="cry-btn" onclick="handleCry(event, 3)">울기</div>
        <div class="oya-mark" onclick="setOya(event, 3)">친</div>
        <div class="content">
            <div class="kanji">북</div>
            <div id="timer-3" class="timer">00:25</div>
            <div class="penalty-container">페널티 <span id="penalty-3" class="penalty-count">0</span></div>
        </div>
    </div>
    <div id="box-1" class="player-box box-1" onclick="handleAreaTap(1)">
        <div class="cry-btn" onclick="handleCry(event, 1)">울기</div>
        <div class="oya-mark" onclick="setOya(event, 1)">친</div>
        <div class="content">
            <div class="kanji">남</div>
            <div id="timer-1" class="timer">00:25</div>
            <div class="penalty-container">페널티 <span id="penalty-1" class="penalty-count">0</span></div>
        </div>
    </div>
    <div id="box-2" class="player-box box-2" onclick="handleAreaTap(2)">
        <div class="cry-btn" onclick="handleCry(event, 2)">울기</div>
        <div class="oya-mark" onclick="setOya(event, 2)">친</div>
        <div class="content">
            <div class="kanji">서</div>
            <div id="timer-2" class="timer">00:25</div>
            <div class="penalty-container">페널티 <span id="penalty-2" class="penalty-count">0</span></div>
        </div>
    </div>
</div>

<div class="controls">
    <button id="main-ctrl-btn" class="btn start-pause-btn" onclick="toggleGame()">대국 시작</button>
    <button class="btn next-btn" onclick="nextKyoku()">국 종료</button>
    <button class="btn finish-btn" onclick="finishGame()">전체 종료</button>
</div>

<script>
    
    let baseTime = 25;              // 설정된 기본 제한시간
    let timers = [25, 25, 25, 25];  // 각 플레이어별 남은 시간
    let penalties = [0, 0, 0, 0];   // 각 플레이어별 페널티 횟수
    let activePlayer = -1;          // 현재 차례인 플레이어 번호 (0~3)
    let oyaPlayer = 0;              // 현재 국의 오야(친) 번호
    let isRunning = false;          // 대국 진행 여부
    let timerId = null;             // 인터벌 타이머
    let wakeLock = null;            // 화면 꺼짐 방지 객체


    // 화면 꺼짐 방지 요청 
    async function requestWakeLock() {
        try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } 
        catch (err) { console.log("WakeLock failed"); }
    }

    // 비프음 재생 
    function playSound(freq, type, duration) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
    }

    // 시간 설정 변경 시 초기화
    function resetTimeSetting() {
        baseTime = parseInt(document.getElementById('time-setter').value);
        timers = [baseTime, baseTime, baseTime, baseTime];
        updateDisplay();
    }

    //  시작/일시정지
    function toggleGame() {
        isRunning = !isRunning;
        const mainBtn = document.getElementById('main-ctrl-btn');
        
        if (isRunning) {
            requestWakeLock(); // 화면 꺼짐 방지 시작
            mainBtn.innerText = "일시 정지";
            mainBtn.classList.add('running');
            if (activePlayer === -1) activePlayer = oyaPlayer; // 첫 시작 시 오야부터 시작
            runTimer();
        } else {
            if (wakeLock) wakeLock.release(); // 화면 꺼짐 방지 해제
            mainBtn.innerText = "대국 재개";
            mainBtn.classList.remove('running');
            clearInterval(timerId); // 타이머 멈춤
        }
    }

    // 1초마다 실행되는 타이머 
    function runTimer() {
        clearInterval(timerId);
        timerId = setInterval(() => {
            if (activePlayer !== -1) {
                timers[activePlayer]--;
                
                // 5초 이하 경고음 및 0초 페널티음
                if (timers[activePlayer] <= 5 && timers[activePlayer] > 0) playSound(600, 'sine', 0.1);
                else if (timers[activePlayer] === 0) playSound(800, 'square', 0.3);

                // 시간 초과 시 페널티 증가 및 시간 리셋
                if (timers[activePlayer] < 0) {
                    penalties[activePlayer]++;
                    timers[activePlayer] = baseTime;
                    if (navigator.vibrate) navigator.vibrate([200, 100, 200]); // 진동 알림
                }
                updateDisplay();
            }
        }, 1000);
    }

    // 오야(친) 수동 설정
    function setOya(event, idx) {
        event.stopPropagation(); // 클릭 이벤트 방지
        if (isRunning) return;    // 진행 중에는 변경 불가
        oyaPlayer = idx;
        updateDisplay();
        playSound(440, 'sine', 0.1);
    }

    // 국 종료 처리 (다음 사람으로 오야 이동)
    function nextKyoku() {
        if (isRunning) toggleGame();
        oyaPlayer = (oyaPlayer + 1) % 4; // 다음 사람에게 친 넘김
        activePlayer = -1;
        timers = [baseTime, baseTime, baseTime, baseTime];
        document.getElementById('main-ctrl-btn').innerText = "다음 국 시작";
        updateDisplay();
        alert("국이 종료되었습니다. 다음 친: " + ["동", "남", "서", "북"][oyaPlayer]);
    }

    // 화면 터치 시 차례 넘기기
    function handleAreaTap(idx) {
        if (!isRunning || activePlayer !== idx) return; 
        timers[activePlayer] = baseTime; // 시간 리셋
        activePlayer = (activePlayer + 1) % 4; // 다음 차례로 이동
        updateDisplay();
    }

    // 울기(치, 퐁, 깡) 버튼 클릭 시 해당 플레이어로 차례 점프
    function handleCry(event, idx) {
        event.stopPropagation();
        if (!isRunning) return;
        timers[activePlayer] = baseTime;
        activePlayer = idx; // 차례 강제 변경
        updateDisplay();
    }
     
    // 전체 게임 종료 및 결과 발표
    function finishGame() {
        if (!confirm("대국을 종료하시겠습니까?")) return;
        if (isRunning) toggleGame();
        const results = `[최종 패널티]\n동: ${penalties[0]}\n남: ${penalties[1]}\n서: ${penalties[2]}\n북: ${penalties[3]}`;
        alert(results);
        // 초기화
        penalties = [0, 0, 0, 0];
        oyaPlayer = 0;
        activePlayer = -1;
        document.getElementById('main-ctrl-btn').innerText = "대국 시작";
        resetTimeSetting();
    }

    // 화면에 현재 상태 반영
    function updateDisplay() {
        for (let i = 0; i < 4; i++) {
            const tEl = document.getElementById(`timer-${i}`);
            const pEl = document.getElementById(`penalty-${i}`);
            const bEl = document.getElementById(`box-${i}`);
            
            // 분:초 형식 계산
            const minutes = Math.floor(Math.max(0, timers[i]) / 60);
            const seconds = Math.max(0, timers[i]) % 45;
            tEl.innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            pEl.innerText = penalties[i];
            
            
            bEl.classList.toggle('active-bg', i === activePlayer);
            tEl.classList.toggle('active-text', i === activePlayer);
            bEl.classList.toggle('is-oya', i === oyaPlayer);

            // 5초 이하 시 빨간색 깜빡임 적용
            if (i === activePlayer && timers[i] <= 5) tEl.classList.add('urgent');
            else tEl.classList.remove('urgent');
        }
    }

    // 앱 실행 시 초기 화면 업데이트
    updateDisplay();
</script>
</body>
</html>
